<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="/" />
  <title>Painel DO-AGA — OLS</title>

  <!-- CSS do projeto -->
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./process_ring.css" />

  <!-- Carregamento 100% LOCAL do Three.js (sem import map, sem CDN, sem top-level await) -->
  <script type="module">
    (async () => {
      try {
        const THREE = await import("./vendor/three/three.module.js");
        const { OrbitControls } = await import("./vendor/three/examples/jsm/controls/OrbitControls.js");
        window.THREE = THREE;
        window.THREE.OrbitControls = OrbitControls;
        window.dispatchEvent(new Event("THREE_READY"));
      } catch (e) {
        console.error("THREE FAILED:", e);
        window.__THREE_LOAD_ERROR__ = e;
        window.dispatchEvent(new Event("THREE_FAILED"));
      }
    })();
  </script>

  <!-- Módulos do OLS (2D + 3D) -->
  <script src="./modules/ols-geom.js" defer></script>
  <script src="./modules/ols-3d.js" defer></script>
  <script src="./modules/ols.js" defer></script>
</head>
<body>
  <div class="vh">
    <header class="bar head">
      <div class="brand">
        <span class="logo">DO-AGA</span>
        <span>OLS</span>
        <small class="build" id="headBuild"></small>
      </div>
      <nav class="nav">
        <a href="./index.html">Início</a>
        <a href="./processos.html">Processos</a>
        <a href="./prazos.html">Prazos</a>
        <a href="./ols.html" aria-current="page">OLS</a>
        <a href="./admin.html">Admin</a>
      </nav>
    </header>

    <main class="main" style="padding:12px;">
      <section class="split" style="grid-template-columns: 360px 1fr; gap:12px;">
        <!-- COLUNA ESQUERDA -->
        <div class="card" style="min-width:320px;">
          <h2>Parâmetros</h2>
          <form id="olsForm" data-ajax>
            <div class="row">
              <label class="grow">Classificação (aproximação)
                <select id="categoria">
                  <option value="nonInstrument">Sem instrumentos</option>
                  <option value="nonPrecision" selected>Não-precisão</option>
                  <option value="catI">Precisão CAT I</option>
                  <option value="catIIIII">Precisão CAT II/III</option>
                </select>
              </label>
              <label>Número de código
                <select id="codeNumber">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                </select>
              </label>
            </div>

            <div class="row">
              <label>Letra de código = F?
                <input type="checkbox" id="codeLetterF" />
              </label>
              <label>Elevação do limiar (m)
                <input type="number" id="thrElev" value="10" step="0.1"/>
              </label>
            </div>

            <div class="row">
              <label class="grow">Comprimento da pista (m)
                <input type="number" id="rwLen" value="1500" step="1"/>
              </label>
              <label>Largura da pista (m)
                <input type="number" id="rwWidth" value="45" step="0.1"/>
              </label>
            </div>

            <div class="row">
              <label class="grow">Heading magnético (graus)
                <input type="number" id="rwHeading" value="170" min="0" max="359" step="0.1"/>
              </label>
              <label class="grow">Rumo (rótulo RWY)
                <input type="number" id="rwyLabelDeg" value="90" min="0" max="359" step="0.1"/>
              </label>
            </div>

            <div class="row">
              <small class="muted">
                Obs.: o heading orienta as superfícies; o “Rumo (rótulo RWY)” calcula as cabeceiras (ex.: 90° → RWY 09/27).
              </small>
            </div>

            <div class="row">
              <label class="grow">
                <input type="checkbox" id="drawA" checked />
                <span id="rwyLabelA">RWY ??</span> (Cabeceira A)
              </label>
              <label class="grow">
                <input type="checkbox" id="drawB" checked />
                <span id="rwyLabelB">RWY ??</span> (Cabeceira B)
              </label>
            </div>

            <div class="row">
              <label class="grow">OHS raio (m)
                <input type="number" id="ohsRadius" value="15000" step="1"/>
              </label>
              <label>OHS altura (m)
                <input type="number" id="ohsHeight" value="150" step="0.1"/>
              </label>
            </div>

            <hr />

            <p class="muted" style="margin-top:4px;">
              <strong>Arquivos CSV</strong> — Terreno (grade) e CSV de obstáculos (pontos).
              Coordenadas locais relativas à <strong>cabeceira A</strong>: X ao longo da pista (para fora de A),
              Y lateral (esquerda positivo) e Z acima do limiar.
            </p>

            <div class="row">
              <label class="grow">Terreno (CSV grade)
                <input type="file" id="fileTerrain" accept=".csv" />
              </label>
            </div>
            <div class="row">
              <label class="grow">Obstáculos (CSV pontos)
                <input type="file" id="fileObstacles" accept=".csv" />
              </label>
            </div>

            <div class="row" style="gap:8px; margin-top:8px;">
              <button type="button" id="btnGerar">Gerar/Atualizar</button>
              <button type="button" id="btnFit" class="secondary">Ajustar planta</button>
              <button type="button" id="btnSave2DPlan" class="secondary">Baixar PNG Planta</button>
              <button type="button" id="btnSave2DProfile" class="secondary">Baixar PNG Perfil</button>
              <button type="button" id="btnSave3D" class="secondary">Baixar PNG 3D</button>
            </div>

            <div id="msg" class="muted" style="margin-top:6px;"></div>
          </form>
        </div>

        <!-- COLUNA DIREITA -->
        <div class="card" id="vizCard" style="min-width:0;">
          <h2>Planta (2D)</h2>
          <div class="row" style="gap:6px; margin:6px 0;">
            <button type="button" id="planZoomIn">+</button>
            <button type="button" id="planZoomOut">−</button>
            <button type="button" id="planZoomReset" class="secondary">100%</button>
            <button type="button" id="planZoomFit" class="secondary">Ajustar</button>
          </div>
          <canvas id="planCanvas" style="width:100%; border:1px solid #ddd;"></canvas>

          <h2 style="margin-top:12px;">Perfil longitudinal (2D)</h2>
          <div class="row" style="gap:6px; margin:6px 0;">
            <button type="button" id="profZoomIn">+</button>
            <button type="button" id="profZoomOut">−</button>
            <button type="button" id="profZoomReset" class="secondary">100%</button>
          </div>
          <canvas id="profileCanvas" style="width:100%; border:1px solid #ddd;"></canvas>

          <h2 style="margin-top:12px;">3D interativo</h2>
          <div class="row" style="gap:6px; margin:6px 0;">
            <button type="button" id="threeZoomIn">+</button>
            <button type="button" id="threeZoomOut">−</button>
            <button type="button" id="threeReset" class="secondary">Reset</button>
            <button type="button" id="threeFit" class="secondary">Ajustar</button>
          </div>
          <div id="ols3d" style="width:100%; border:1px solid #ddd; background:#fff;"></div>
          <div id="ols3dFallback" class="muted" style="display:none;margin-top:6px;">
            Não foi possível carregar o Three.js. Garanta estes arquivos locais:<br>
            <code>public/vendor/three/three.module.js</code><br>
            <code>public/vendor/three/examples/jsm/controls/OrbitControls.js</code>
          </div>
        </div>
      </section>
    </main>

    <footer class="foot">
      <div class="muted">Build: <span id="footBuild">OLS-3D</span></div>
    </footer>
  </div>
</body>
</html>
